<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <link href="clixSheet.css" rel="stylesheet" type="text/css">
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>
    <div class="controls">
      <div class="setnumber">
        <label>Dial</label>
        <textarea class="statsentry" type="text" name="attr_dial" placeholder="To get started find your BBCode and paste here"></textarea>
        <button type="action" name="act_populate">Populate Dial</button>
      </div>
      <div>
        <label>Click Number</label>
        <input type="number" name="attr_click">
      </div>
      <div>
        <label>Range</label>
        <input type="text" name="attr_damage_current_max">
      </div>
      <div>
        <label>Powers</label>
        <textarea class="statsentry" type="text" name="attr_powers"></textarea>
      </div>
    </div>
    <div class="current_stats">
        <div>
          <label>Speed</label>
          <input type="text" name="attr_click_max" readonly="readonly">
        </div>
        <div>
          <label>Attack</label>
          <input type="text" name="attr_attack_current" readonly="readonly">
        </div>
        <div>
          <label>Defense</label>
          <input type="text" name="attr_attack_current_max" readonly="readonly">
        </div>
        <div>
          <label>Damage</label>
          <input type="text" name="attr_damage_current" readonly="readonly">
        </div>
    </div>
    <break/>
    <fieldset class="repeating_clicks">
      <div>
        <label>Speed</label>
        <input type="number" name="attr_speed">
        <select name="attr_speedpowers">
          <option value="None">None</option>
          <option value="Ch">Charge (Ch)</option>
          <option value="En">Earthbound (En)</option>
          <option value="Fl">Flurry (Fl)</option>
          <option value="Fb">Force Blast (Fb)</option>
          <option value="Hs">Hypersonic Speed (Hs)</option>
          <option value="Lc">Leap/Climb (Lc)</option>
          <option value="Mc">Mind Control (Mc)</option>
          <option value="Pt">Phasing/Teleport (Pt)</option>
          <option value="Pl">Plasticity (Pl)</option>
          <option value="Rs">Running Shot (Rs)</option>
          <option value="Si">Sidestep (Si)</option>
          <option value="St">Stealth (St)</option>
          <option value="Sp">Special (Sp)</option>
        </select>
      </div>
      <div>
        <label>Attack</label>
        <input type="number" name="attr_attack">
        <select name="attr_attackpowers">
          <option value="None">None</option>
          <option value="Bc">Blades/Claws (Bc)</option>
          <option value="In">Incapacitate (In)</option>
          <option value="Pb">Penetrating/Psychic Blast (Pb)</option>
          <option value="Po">Poison (Po)</option>
          <option value="Pw">Pulse Wave (Pw)</option>
          <option value="Qu">Quake (Qu)</option>
          <option value="Sm">Smoke Cloud (Sm)</option>
          <option value="Se">Steal Energy (Se)</option>
          <option value="Ss">Super Strength (Ss)</option>
          <option value="Tk">Telekinesis (Tk)</option>
          <option value="Ps">Precision Strike (Ps)</option>
          <option value="Ee">Energy Explosion (Ee)</option>
          <option value="Sp">Special (Sp)</option>
        </select>
      </div>
      <div>
        <label>Defense</label>
        <input type="number" name="attr_defense">
        <select name="attr_defensepowers">
          <option value="None">None</option>
          <option value="Ba">Barrier (Ba)</option>
          <option value="Cr">Combat Reflexes (Cr)</option>
          <option value="De">Defend (De)</option>
          <option value="Ed">Energy Shield/Deflection (Ed)</option>
          <option value="Im">Impervious (Im)</option>
          <option value="In">Invincible (In)</option>
          <option value="Iv">Invulnerable (Iv)</option>
          <option value="Ma">Mastermind (Ma)</option>
          <option value="Re">Regeneration (Re)</option>
          <option value="Su">Super Senses (Su)</option>
          <option value="To">Toughness (To)</option>
          <option value="Wi">Willpower (Wi)</option>
          <option value="Sp">Special (Sp)</option>
        </select>
      </div>
      <div>
        <label>Damage</label>
        <input type="number" name="attr_damage">
        <select name="attr_damagepowers">
          <option value="None">None</option>
          <option value="Bf">Battle Fury (Bf)</option>
          <option value="Ce">Close Combat Expert (Ce)</option>
          <option value="Em">Empower (Em)</option>
          <option value="Eh">Enhancement (Eh)</option>
          <option value="Ew">Exploit Weakness (Ew)</option>
          <option value="Le">Leadership (Le)</option>
          <option value="Ou">Outwit (Ou)</option>
          <option value="Pe">Perplex (Pe)</option>
          <option value="Pc">Probability Control (Pc)</option>
          <option value="Rc">Ranged Comabt Expert (Rc)</option>
          <option value="Sc">Shape Change (Sc)</option>
          <option value="So">Support (Sp)</option>
          <option value="Sp">Special (Sp)</option>
        </select>
      </div>
    </fieldset>
  </body>
  <script type="text/worker">

  /*on("sheet:opened", function() {
    var default_attr = {};
    getAttrs(["click"], function(currentClick) {
    default_attr["width"] = 70;
    default_attr["height"] = 70;
    default_attr["bar1_value"] = 10;
    default_attr["bar1_max"] = 15;

  }*/

    function powerLookup(powerMap, powerName) {
      if(hasOwnProperty.call(powerMap, powerName.toLowerCase())){
        return powerMap[powerName.toLowerCase()];
      } else{
        return "None";
      }
    }

    function powerSet(values, attributeName) {
      if(values[attributeName]!="None"){
        return "(" + values[attributeName] + ")";
      } else {
        return "";
      }
    }


    on("clicked:populate", function(){

      getSectionIDs("clicks", function(idArray) {
        console.log("FIRST ID: " + idArray[0]);
        for(var id = 0; id < idArray.length; id++){
          removeRepeatingRow("repeating_clicks_" + idArray[id]);
        }

      });



      getAttrs(["dial"], function(dialCode){
        var bbCode = dialCode.dial;


        var rangeRegEx = /\Range:\ \[b\]([0-9]*)/;
        var range = rangeRegEx.exec(bbCode);

        console.log("RANGE: " + range);
        setAttrs({
          damage_current_max: range[1]
        });

        var powersRegEx = /\((.*)\[\/b\](.*)/g;

        var allPowers="";

        while( match = powersRegEx.exec(bbCode)){
          console.log("POWERS: " + match);
          allPowers = allPowers + match[1] + match[2] + "\n";
        }
        setAttrs({
          powers: allPowers
        });

        var regEx = /\[slot=([a-z]*)]([0-9]*)\[\/slot]/g;
        var speedPowers = {
          "green" : "Ch",
          "lime" : "En",
          "red" : "Fl",
          "purple" : "Fb",
          "brown" : "Hs",
          "orange" : "Lc",
          "blue" : "Mc",
          "yellow" : "Pt",
          "darkblue" : "Pl",
          "gray" : "Rs",
          "pink" : "Si",
          "black" : "St",
          "special" : "Sp"
        };
        var attackPowers = {
          "red" : "Bc",
          "blue" : "In",
          "darkblue" : "Pb",
          "brown" : "Po",
          "yellow" : "Pw",
          "lime" : "Qu",
          "purple" : "Sm",
          "black" : "Se",
          "gray" : "Tk",
          "pink" : "Ps",
          "orange" : "Ee",
          "green" : "Ss",
          "special" : "Sp"
        };
        var defensePowers = {
          "green" : "Ed",
          "lime" : "Cr",
          "red" : "Su",
          "purple" : "Wi",
          "brown" : "Im",
          "orange" : "To",
          "blue" : "Ba",
          "yellow" : "De",
          "darkblue" : "Ma",
          "gray" : "Iv",
          "pink" : "In",
          "black" : "Re",
          "special" : "Sp"
        };
        var damagePowers = {
          "green" : "Eh",
          "lime" : "Ew",
          "red" : "Rc",
          "purple" : "Ce",
          "brown" : "Pe",
          "orange" : "Bf",
          "blue" : "Pc",
          "yellow" : "So",
          "darkblue" : "Sc",
          "gray" : "Le",
          "pink" : "Em",
          "black" : "Ou",
          "special" : "Sp"
        };
        console.log(typeof speedPowers);
        while( match = regEx.exec(bbCode)){
          console.log("DIAL CODE:", match);
          var rowID = generateRowID();
          var rowAttrs = {};
          rowAttrs["repeating_clicks_" + rowID + "_speed"] = match[2];
          rowAttrs["repeating_clicks_" + rowID + "_speedpowers"] = powerLookup(speedPowers, match[1]);
          match = regEx.exec(bbCode);
          rowAttrs["repeating_clicks_" + rowID + "_attack"] = match[2];
          rowAttrs["repeating_clicks_" + rowID + "_attackpowers"] = powerLookup(attackPowers, match[1]);
          match = regEx.exec(bbCode);
          rowAttrs["repeating_clicks_" + rowID + "_defense"] = match[2];
          rowAttrs["repeating_clicks_" + rowID + "_defensepowers"] = powerLookup(defensePowers, match[1]);
          match = regEx.exec(bbCode);
          rowAttrs["repeating_clicks_" + rowID + "_damage"] = match[2];
          rowAttrs["repeating_clicks_" + rowID + "_damagepowers"] = powerLookup(damagePowers, match[1]);

          setAttrs(rowAttrs);
        }


      });

    });

    on("change:click", function() {
      console.log("HI");
      getAttrs(["click"], function(currentClick) {
        console.log("CLICK" + currentClick.click);
        getSectionIDs("clicks", function(idArray) {
         console.log("IDS" + idArray[0]);
         getAttrs(["repeating_clicks_" + idArray[currentClick.click-1] +"_speed",
                  "repeating_clicks_" + idArray[currentClick.click-1] +"_attack",
                  "repeating_clicks_" + idArray[currentClick.click-1] +"_defense",
                  "repeating_clicks_" + idArray[currentClick.click-1] +"_damage",
                  "repeating_clicks_" + idArray[currentClick.click-1] +"_speedpowers",
                  "repeating_clicks_" + idArray[currentClick.click-1] +"_attackpowers",
                  "repeating_clicks_" + idArray[currentClick.click-1] +"_defensepowers",
                  "repeating_clicks_" + idArray[currentClick.click-1] +"_damagepowers"], function(values) {
          console.log("VALUES" + idArray.length);
          var speed = "";
          var attack = "";
          var defense = "";
          var damage = "";
          if(currentClick.click <= idArray.length){
            speed = values["repeating_clicks_" + idArray[currentClick.click-1] +"_speed"]
                                                    + powerSet(values, "repeating_clicks_" + idArray[currentClick.click-1] +"_speedpowers");
            attack = values["repeating_clicks_" + idArray[currentClick.click-1] +"_attack"]
                                                          + powerSet(values, "repeating_clicks_" + idArray[currentClick.click-1] +"_attackpowers");
            defense = values["repeating_clicks_" + idArray[currentClick.click-1] +"_defense"]
                                                            + powerSet(values, "repeating_clicks_" + idArray[currentClick.click-1] +"_defensepowers");
            damage = values["repeating_clicks_" + idArray[currentClick.click-1] +"_damage"]
                                                        + powerSet(values, "repeating_clicks_" + idArray[currentClick.click-1] +"_damagepowers");
          }
          else{
            speed = "0(KO)";
            attack = "0(KO)";
            defense = "0(KO)";
            damage = "0(KO)";
          }
          setAttrs({
            click_max: speed,
            attack_current: attack,
            attack_current_max: defense,
            damage_current: damage
          });
        });
      });
    });
  });

  // ... etc

  </script>
</html>
